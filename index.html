<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Home Board Log Pro</title>
    <style>
        :root {
            --start-color: #4CAF50;
            --hand-color: #FF9800;
            --foot-color: #2196F3;
            --finish-color: #F44336;
            --dark: #1a1a1a;
            --card-bg: #2a2a2a;
            --light: #f4f4f4;
            --accent: #00BCD4;
            --benchmark-gold: #FFD700;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark);
            color: var(--light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 10px 15px;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            z-index: 10;
        }

        h1 { margin: 0; font-size: 1.1rem; }

        #app-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        /* --- Zoom/Pan Board Wrapper --- */
        #viewport {
            width: 100%;
            height: 350px; 
            overflow: hidden;
            background: #000;
            position: relative;
            touch-action: none;
        }

        #board-wrapper {
            position: absolute;
            width: 100%;
            transform-origin: 0 0;
            cursor: crosshair;
        }

        #board-image {
            width: 100%;
            display: block;
            pointer-events: none;
        }

        .hold-marker {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            pointer-events: none; 
            border: 1.5px solid rgba(255,255,255,0.8);
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            color: white;
            opacity: 0.85;
        }

        .hold-marker.type-start { background-color: var(--start-color); }
        .hold-marker.type-hand { background-color: var(--hand-color); }
        .hold-marker.type-foot { background-color: var(--foot-color); width: 16px; height: 16px; }
        .hold-marker.type-finish { background-color: var(--finish-color); border: 2px dashed white; }

        .controls { padding: 15px; background: var(--dark); }
        
        .marker-toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #000;
            padding: 5px;
            border-radius: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            color: #666;
            transition: 0.2s;
        }

        .type-btn.active { color: white; background: #333; font-weight: bold; }
        .type-btn.active[data-type="start"] { color: var(--start-color); }
        .type-btn.active[data-type="hand"] { color: var(--hand-color); }
        .type-btn.active[data-type="foot"] { color: var(--foot-color); }
        .type-btn.active[data-type="finish"] { color: var(--finish-color); }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn-primary { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: #444; color: white; }

        .filter-bar {
            background: #111;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            position: sticky;
            top: 0;
            z-index: 5;
            border-bottom: 1px solid #333;
        }

        .route-card {
            background: var(--card-bg);
            margin: 12px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .route-card.benchmark { border-left-color: var(--benchmark-gold); }
        .benchmark-badge { 
            color: var(--benchmark-gold); 
            font-size: 0.7rem; 
            font-weight: bold; 
            text-transform: uppercase;
        }

        .route-header { display: flex; justify-content: space-between; align-items: center; }
        .route-title { font-size: 1.1rem; font-weight: bold; }
        .route-grade { color: var(--accent); font-weight: bold; }
        .stars { color: #ffb400; font-size: 0.9rem; }

        nav {
            display: flex;
            background: #111;
            border-top: 1px solid #333;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .nav-item.active { color: var(--accent); border-top: 2px solid var(--accent); }

        #setup-screen { padding: 40px; text-align: center; }
    </style>
</head>
<body>

    <header>
        <h1>ðŸ§— Home Board Log</h1>
        <button onclick="clearData()" style="background:none; border:none; color:#555; font-size:10px;">Reset App</button>
    </header>

    <div id="app-container">
        <div id="setup-screen">
            <h2>Welcome!</h2>
            <p>Upload a photo of your board to start.</p>
            <input type="file" id="imgInput" accept="image/*">
        </div>

        <div id="create-view" style="display:none;">
            <div id="viewport">
                <div id="board-wrapper">
                    <img id="board-image" src="" alt="Board">
                    <div id="markers-container"></div>
                </div>
            </div>
            
            <div style="background:#111; padding: 5px 15px; font-size: 10px; color: #777;">
                Pinch/Scroll to Zoom â€¢ Drag to Pan â€¢ Tap to Place
                <button onclick="resetZoom()" style="float:right; background:none; border:1px solid #444; color:#aaa; border-radius:3px;">Reset Zoom</button>
            </div>

            <div class="controls">
                <div class="marker-toolbar">
                    <div class="type-btn active" onclick="setHoldType('start')" data-type="start">Start</div>
                    <div class="type-btn" onclick="setHoldType('hand')" data-type="hand">Hand</div>
                    <div class="type-btn" onclick="setHoldType('foot')" data-type="foot">Foot</div>
                    <div class="type-btn" onclick="setHoldType('finish')" data-type="finish">Finish</div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="undoLastMove()">Undo</button>
                    <button class="btn btn-secondary" onclick="clearMoves()">Clear Holds</button>
                </div>

                <input type="text" id="route-name" placeholder="Route Name">
                
                <div style="display:flex; gap:10px;">
                    <input type="text" id="route-grade" placeholder="Grade (e.g. V4)" style="flex:1;">
                    <select id="route-rating" style="flex:1.2;">
                        <option value="0">No Rating</option>
                        <option value="1">â˜…â˜†â˜† (Worth doing)</option>
                        <option value="2">â˜…â˜…â˜† (Great)</option>
                        <option value="3">â˜…â˜…â˜… (Classic)</option>
                    </select>
                </div>

                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; background:#2a2a2a; padding:10px; border-radius:6px;">
                    <input type="checkbox" id="route-benchmark" style="width:auto; margin:0;">
                    <label for="route-benchmark" style="font-size:0.9rem;">Mark as Benchmark</label>
                </div>

                <select id="route-feet">
                    <option value="Any Feet">Any Feet</option>
                    <option value="Tracking">Tracking</option>
                    <option value="Kickboard Only">Kickboard Only</option>
                    <option value="No Feet">No Feet</option>
                </select>

                <textarea id="route-notes" rows="2" placeholder="Notes..."></textarea>
                <button class="btn btn-primary" onclick="saveRoute()">Save to Logbook</button>
            </div>
        </div>

        <div id="list-view" style="display:none;">
            <div class="filter-bar">
                <input type="text" id="filter-grade" placeholder="Grade..." oninput="renderLogbook()" style="margin:0; flex:1; min-width: 80px;">
                
                <select id="filter-rating" onchange="renderLogbook()" style="margin:0; flex:1;">
                    <option value="all">All Stars</option>
                    <option value="3">â˜…â˜…â˜… Only</option>
                    <option value="2">â˜…â˜…â˜† & up</option>
                    <option value="1">â˜…â˜†â˜† & up</option>
                </select>

                <select id="filter-bench" onchange="renderLogbook()" style="margin:0; flex:1;">
                    <option value="all">All Types</option>
                    <option value="benchmark">Benchmarks</option>
                </select>
            </div>
            <div id="routes-list"></div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" id="nav-create" onclick="switchTab('create')">CREATE</div>
        <div class="nav-item" id="nav-list" onclick="switchTab('list')">LOGBOOK</div>
    </nav>

    <script>
        let currentMoves = [];
        let savedRoutes = JSON.parse(localStorage.getItem('myRoutes')) || [];
        let boardImgData = localStorage.getItem('boardImage');
        let currentHoldType = 'start';

        let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

        const viewport = document.getElementById('viewport');
        const boardWrapper = document.getElementById('board-wrapper');
        const boardImage = document.getElementById('board-image');
        const setupScreen = document.getElementById('setup-screen');
        const createView = document.getElementById('create-view');
        const listView = document.getElementById('list-view');

        if (boardImgData) {
            boardImage.src = boardImgData;
            setupScreen.style.display = 'none';
            createView.style.display = 'block';
        }

        document.getElementById('imgInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                boardImage.src = reader.result;
                localStorage.setItem('boardImage', reader.result); 
                setupScreen.style.display = 'none';
                createView.style.display = 'block';
            }
            if (file) reader.readAsDataURL(file);
        });

        boardWrapper.addEventListener('click', function(e) {
            if (isDragging) return;
            const rect = boardWrapper.getBoundingClientRect();
            const xPct = ((e.clientX - rect.left) / rect.width) * 100;
            const yPct = ((e.clientY - rect.top) / rect.height) * 100;
            let orderNum = 0;
            if(currentHoldType !== 'foot') {
                orderNum = currentMoves.filter(m => m.type !== 'foot').length + 1;
            }
            currentMoves.push({ x: xPct, y: yPct, type: currentHoldType, order: orderNum });
            if(currentHoldType === 'start') setHoldType('hand');
            renderMarkers();
        });

        function renderMarkers() {
            const container = document.getElementById('markers-container');
            container.innerHTML = ''; 
            currentMoves.forEach((move) => {
                const el = document.createElement('div');
                el.className = `hold-marker type-${move.type}`;
                el.style.left = move.x + '%';
                el.style.top = move.y + '%';
                if (move.type !== 'foot') el.innerText = move.order; 
                container.appendChild(el);
            });
        }

        viewport.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - posX;
            startY = e.clientY - posY;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            posX = e.clientX - startX;
            posY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => { setTimeout(() => isDragging = false, 50); });

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSpeed = 0.002;
            scale -= e.deltaY * zoomSpeed;
            scale = Math.min(Math.max(0.5, scale), 4);
            updateTransform();
        });

        function updateTransform() {
            boardWrapper.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        function resetZoom() {
            scale = 1; posX = 0; posY = 0;
            updateTransform();
        }

        function setHoldType(type) {
            currentHoldType = type;
            document.querySelectorAll('.type-btn').forEach(el => el.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${type}"]`).classList.add('active');
        }

        function saveRoute() {
            const name = document.getElementById('route-name').value;
            if (!name) return alert("Please name your route!");
            const newRoute = {
                id: Date.now(),
                name: name,
                grade: document.getElementById('route-grade').value || "?",
                rating: parseInt(document.getElementById('route-rating').value),
                isBenchmark: document.getElementById('route-benchmark').checked,
                feet: document.getElementById('route-feet').value,
                notes: document.getElementById('route-notes').value,
                moves: [...currentMoves],
                ascents: []
            };
            savedRoutes.unshift(newRoute);
            localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
            clearMoves();
            document.getElementById('route-name').value = '';
            document.getElementById('route-benchmark').checked = false;
            alert("Route Saved!");
            switchTab('list');
        }

        function renderLogbook() {
            const container = document.getElementById('routes-list');
            const gFilter = document.getElementById('filter-grade').value.toLowerCase();
            const bFilter = document.getElementById('filter-bench').value;
            const rFilter = document.getElementById('filter-rating').value;

            const filtered = savedRoutes.filter(r => {
                const matchesGrade = r.grade.toLowerCase().includes(gFilter);
                const matchesBench = (bFilter === 'benchmark') ? r.isBenchmark : true;
                const matchesRating = (rFilter === 'all') ? true : r.rating >= parseInt(rFilter);
                return matchesGrade && matchesBench && matchesRating;
            });

            container.innerHTML = filtered.length ? '' : '<p style="text-align:center; padding:40px; color:#666;">No matching routes found.</p>';

            filtered.forEach(route => {
                const card = document.createElement('div');
                card.className = `route-card ${route.isBenchmark ? 'benchmark' : ''}`;
                const stars = "â˜…".repeat(route.rating) + "â˜†".repeat(3 - route.rating);
                card.innerHTML = `
                    ${route.isBenchmark ? '<div class="benchmark-badge">â—† Benchmark</div>' : ''}
                    <div class="route-header">
                        <span class="route-title">${route.name}</span>
                        <span class="route-grade">${route.grade}</span>
                    </div>
                    <div class="stars">${stars}</div>
                    <div style="font-size:0.8rem; color:#aaa; margin:5px 0;">${route.feet} â€¢ ${route.moves.length} holds</div>
                    <div style="font-size:0.85rem; font-style:italic; color:#888;">"${route.notes || ''}"</div>
                    <div style="margin-top:12px; display:flex; gap:10px;">
                        <button class="btn-secondary" style="flex:1; padding:5px; font-size:12px; border-radius:4px;" onclick="loadRoute(${route.id})">View Board</button>
                        <button class="btn-primary" style="flex:1; padding:5px; font-size:12px; border-radius:4px;" onclick="deleteRoute(${route.id})">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function loadRoute(id) {
            const route = savedRoutes.find(r => r.id === id);
            currentMoves = route.moves;
            renderMarkers();
            switchTab('create');
            resetZoom();
        }

        function undoLastMove() { currentMoves.pop(); renderMarkers(); }
        function clearMoves() { currentMoves = []; renderMarkers(); setHoldType('start'); }

        function deleteRoute(id) {
            if(confirm("Delete this route?")) {
                savedRoutes = savedRoutes.filter(r => r.id !== id);
                localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
                renderLogbook();
            }
        }

        function switchTab(tab) {
            createView.style.display = tab === 'create' ? 'block' : 'none';
            listView.style.display = tab === 'list' ? 'block' : 'none';
            document.getElementById('nav-create').className = `nav-item ${tab === 'create' ? 'active' : ''}`;
            document.getElementById('nav-list').className = `nav-item ${tab === 'list' ? 'active' : ''}`;
            if(tab === 'list') renderLogbook();
        }

        function clearData() {
            if(confirm("Factory reset? This deletes ALL routes and your board image.")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>