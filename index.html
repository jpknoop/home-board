<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home Board Log Pro</title>
    <style>
        :root {
            --start-color: #4CAF50;
            --hand-color: #FF9800;
            --foot-color: #2196F3;
            --finish-color: #F44336;
            --dark: #1a1a1a;
            --card-bg: #2a2a2a;
            --light: #f4f4f4;
            --accent: #00BCD4;
            --benchmark-gold: #FFD700;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark);
            color: var(--light);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        header {
            padding: 10px 15px; background: #111;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; z-index: 10;
        }

        #app-container { flex: 1; overflow-y: auto; position: relative; }

        /* --- Viewport & Zoom Container --- */
        #viewport {
            width: 100%; height: 45vh;
            overflow: hidden; background: #000;
            position: relative; touch-action: none;
            cursor: grab;
        }
        #viewport:active { cursor: grabbing; }

        #board-wrapper {
            position: absolute; width: 100%;
            transform-origin: 0 0; will-change: transform;
            /* Faster transition for responsiveness */
            transition: transform 0.05s linear;
        }

        #board-image { width: 100%; display: block; pointer-events: none; }

        .hold-marker {
            position: absolute; width: 22px; height: 22px;
            border-radius: 50%; transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 10px; pointer-events: none;
            border: 1.5px solid white; color: white;
            z-index: 5;
        }
        .hold-marker.type-start { background-color: var(--start-color); }
        .hold-marker.type-hand { background-color: var(--hand-color); }
        .hold-marker.type-foot { background-color: var(--foot-color); width: 16px; height: 16px; }
        .hold-marker.type-finish { background-color: var(--finish-color); border: 2px dashed white; }

        /* --- UI Controls --- */
        .controls { padding: 15px; background: var(--dark); }
        
        .zoom-control-bar {
            background: #222; padding: 10px 15px;
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid #333;
        }
        
        .zoom-slider { flex: 1; accent-color: var(--accent); cursor: pointer; }

        .marker-toolbar {
            display: flex; justify-content: space-between;
            margin-bottom: 10px; background: #000;
            padding: 5px; border-radius: 8px;
        }

        .type-btn { flex: 1; padding: 12px 0; text-align: center; font-size: 0.8rem; color: #666; cursor: pointer; }
        .type-btn.active { color: white; background: #333; border-radius: 4px; font-weight: bold; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #2a2a2a; border: 1px solid #444; color: white;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }

        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-bottom: 8px; cursor: pointer; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: #444; color: white; }
        .btn-update { background-color: #FF9800; color: white; }

        /* --- Logbook --- */
        .filter-bar { background: #111; padding: 10px; display: flex; gap: 5px; position: sticky; top: 0; z-index: 5; }
        .route-card { background: var(--card-bg); margin: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); }
        .route-card.benchmark { border-left-color: var(--benchmark-gold); }
        
        nav { display: flex; background: #111; border-top: 1px solid #333; }
        .nav-item { flex: 1; text-align: center; padding: 15px; color: #777; font-size: 0.8rem; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--accent); border-top: 2px solid var(--accent); }
    </style>
</head>
<body>

    <header>
        <h1>ðŸ§— Home Board Log</h1>
        <button onclick="clearData()" style="color:#555; background:none; border:none; font-size:10px;">RESET ALL</button>
    </header>

    <div id="app-container">
        <div id="setup-screen" style="padding:50px; text-align:center;">
            <h2>Upload Board Photo</h2>
            <input type="file" id="imgInput" accept="image/*">
        </div>

        <div id="create-view" style="display:none;">
            <div id="viewport">
                <div id="board-wrapper">
                    <img id="board-image" src="" alt="Board">
                    <div id="markers-container"></div>
                </div>
            </div>
            
            <div class="zoom-control-bar">
                <span style="font-size: 12px;">Zoom</span>
                <input type="range" class="zoom-slider" id="zoomSlider" min="1" max="4" step="0.1" value="1">
                <button onclick="resetView()" style="background:none; border:1px solid #555; color:#aaa; font-size:10px; padding:4px 8px;">RESET</button>
            </div>

            <div class="controls">
                <div class="marker-toolbar">
                    <div class="type-btn active" onclick="setHoldType('start')" data-type="start">Start</div>
                    <div class="type-btn" onclick="setHoldType('hand')" data-type="hand">Hand</div>
                    <div class="type-btn" onclick="setHoldType('foot')" data-type="foot">Foot</div>
                    <div class="type-btn" onclick="setHoldType('finish')" data-type="finish">Finish</div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="flex:1" onclick="undoLastMove()">Undo</button>
                    <button class="btn btn-secondary" style="flex:1" onclick="clearMoves()">Clear</button>
                </div>

                <input type="text" id="route-name" placeholder="Route Name">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="route-grade" placeholder="Grade" style="flex:1;">
                    <select id="route-rating" style="flex:1.5;">
                        <option value="0">No Rating</option>
                        <option value="1">â˜…â˜†â˜†</option>
                        <option value="2">â˜…â˜…â˜†</option>
                        <option value="3">â˜…â˜…â˜…</option>
                    </select>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; background:#2a2a2a; padding:10px; border-radius:6px;">
                    <input type="checkbox" id="route-benchmark" style="width:auto; margin:0;">
                    <label style="font-size:0.9rem;">Benchmark Route</label>
                </div>
                <textarea id="route-notes" rows="2" placeholder="Notes..."></textarea>
                
                <button id="save-btn" class="btn btn-primary" onclick="saveRoute()">Save Route</button>
                <button id="update-btn" class="btn btn-update" style="display:none;" onclick="updateRoute()">Update Route</button>
                <button id="cancel-edit-btn" class="btn btn-secondary" style="display:none;" onclick="cancelEdit()">Cancel Edit</button>
            </div>
        </div>

        <div id="list-view" style="display:none;">
            <div class="filter-bar">
                <input type="text" id="filter-grade" placeholder="Grade" oninput="renderLogbook()" style="margin:0; flex:1;">
                <select id="filter-rating" onchange="renderLogbook()" style="margin:0; flex:1;">
                    <option value="all">Stars</option>
                    <option value="3">â˜…â˜…â˜…</option>
                    <option value="2">â˜…â˜…â˜†+</option>
                    <option value="1">â˜…â˜†â˜†+</option>
                </select>
                <select id="filter-bench" onchange="renderLogbook()" style="margin:0; flex:1;">
                    <option value="all">All</option>
                    <option value="benchmark">Bench</option>
                </select>
            </div>
            <div id="routes-list"></div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" id="nav-create" onclick="switchTab('create')">CREATE</div>
        <div class="nav-item" id="nav-list" onclick="switchTab('list')">LOGBOOK</div>
    </nav>

    <script>
        let currentMoves = [];
        let savedRoutes = JSON.parse(localStorage.getItem('myRoutes')) || [];
        let boardImgData = localStorage.getItem('boardImage');
        let currentHoldType = 'start';
        let editingRouteId = null;

        // View State
        let scale = 1, posX = 0, posY = 0, startX = 0, startY = 0, isDragging = false;

        const viewport = document.getElementById('viewport');
        const boardWrapper = document.getElementById('board-wrapper');
        const boardImage = document.getElementById('board-image');
        const zoomSlider = document.getElementById('zoomSlider');

        if (boardImgData) {
            boardImage.src = boardImgData;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('create-view').style.display = 'block';
        }

        document.getElementById('imgInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => {
                boardImage.src = reader.result;
                localStorage.setItem('boardImage', reader.result);
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('create-view').style.display = 'block';
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // --- UNIFIED ZOOM & DRAG ENGINE ---

        // 1. Zoom Slider
        zoomSlider.oninput = (e) => {
            scale = parseFloat(e.target.value);
            updateTransform();
        };

        // 2. Desktop Mouse Wheel Support
        viewport.onwheel = (e) => {
            e.preventDefault();
            const step = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.min(Math.max(1, scale + step), 4);
            zoomSlider.value = scale;
            updateTransform();
        };

        // 3. Unified Drag Logic (Mouse & Touch)
        const startDrag = (e) => {
            isDragging = true;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            startX = clientX - posX;
            startY = clientY - posY;
        };

        const moveDrag = (e) => {
            if (!isDragging) return;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            posX = clientX - startX;
            posY = clientY - startY;
            updateTransform();
        };

        const endDrag = () => { isDragging = false; };

        viewport.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', moveDrag);
        window.addEventListener('mouseup', endDrag);

        viewport.addEventListener('touchstart', startDrag);
        window.addEventListener('touchmove', moveDrag);
        window.addEventListener('touchend', endDrag);

        // 4. Tap/Click to Place Hold
        viewport.onclick = (e) => {
            // Prevent placing hold if we were just dragging
            if (isDragging) return;

            const rect = boardWrapper.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            let order = currentHoldType === 'foot' ? 0 : currentMoves.filter(m => m.type !== 'foot').length + 1;
            currentMoves.push({ x, y, type: currentHoldType, order });
            if (currentHoldType === 'start') setHoldType('hand');
            renderMarkers();
        };

        function updateTransform() {
            boardWrapper.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        function resetView() {
            scale = 1; posX = 0; posY = 0; zoomSlider.value = 1; updateTransform();
        }

        // --- RENDER & DATA ---

        function renderMarkers() {
            const container = document.getElementById('markers-container');
            container.innerHTML = '';
            currentMoves.forEach(m => {
                const el = document.createElement('div');
                el.className = `hold-marker type-${m.type}`;
                el.style.left = m.x + '%'; el.style.top = m.y + '%';
                if (m.type !== 'foot') el.innerText = m.order;
                container.appendChild(el);
            });
        }

        function setHoldType(t) {
            currentHoldType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t));
        }

        function saveRoute() {
            const name = document.getElementById('route-name').value;
            if (!name) return alert("Please name your route!");
            savedRoutes.unshift({
                id: Date.now(), name,
                grade: document.getElementById('route-grade').value || "?",
                rating: parseInt(document.getElementById('route-rating').value),
                isBenchmark: document.getElementById('route-benchmark').checked,
                notes: document.getElementById('route-notes').value,
                moves: [...currentMoves]
            });
            localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
            cancelEdit(); switchTab('list');
        }

        function editRoute(id) {
            const route = savedRoutes.find(r => r.id === id);
            editingRouteId = id;
            document.getElementById('route-name').value = route.name;
            document.getElementById('route-grade').value = route.grade;
            document.getElementById('route-rating').value = route.rating || 0;
            document.getElementById('route-benchmark').checked = route.isBenchmark || false;
            document.getElementById('route-notes').value = route.notes || "";
            currentMoves = [...route.moves];
            
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('update-btn').style.display = 'block';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            renderMarkers(); switchTab('create'); resetView();
        }

        function updateRoute() {
            const index = savedRoutes.findIndex(r => r.id === editingRouteId);
            savedRoutes[index] = {...savedRoutes[index],
                name: document.getElementById('route-name').value,
                grade: document.getElementById('route-grade').value,
                rating: parseInt(document.getElementById('route-rating').value),
                isBenchmark: document.getElementById('route-benchmark').checked,
                notes: document.getElementById('route-notes').value,
                moves: [...currentMoves]
            };
            localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
            cancelEdit(); switchTab('list');
        }

        function cancelEdit() {
            editingRouteId = null; currentMoves = []; renderMarkers();
            document.getElementById('route-name').value = '';
            document.getElementById('route-grade').value = '';
            document.getElementById('route-notes').value = '';
            document.getElementById('route-benchmark').checked = false;
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('update-btn').style.display = 'none';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function deleteRoute(id) {
            if(confirm("Delete this route?")) {
                savedRoutes = savedRoutes.filter(r => r.id !== id);
                localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
                renderLogbook();
            }
        }

        function renderLogbook() {
            const container = document.getElementById('routes-list');
            const gF = document.getElementById('filter-grade').value.toLowerCase();
            const rF = document.getElementById('filter-rating').value;
            const bF = document.getElementById('filter-bench').value;
            container.innerHTML = '';
            savedRoutes.filter(r => {
                const mg = r.grade.toLowerCase().includes(gF);
                const mr = rF === 'all' ? true : r.rating >= parseInt(rF);
                const mb = bF === 'all' ? true : r.isBenchmark;
                return mg && mr && mb;
            }).forEach(r => {
                const card = document.createElement('div');
                card.className = `route-card ${r.isBenchmark ? 'benchmark' : ''}`;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between"><strong>${r.name}</strong> <span>${r.grade}</span></div>
                    <div style="color:#ffb400; margin:5px 0;">${"â˜…".repeat(r.rating)}${"â˜†".repeat(3-r.rating)}</div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn-secondary" style="flex:1; padding:5px; font-size:11px;" onclick="viewRoute(${r.id})">VIEW</button>
                        <button class="btn-primary" style="flex:1; padding:5px; font-size:11px;" onclick="editRoute(${r.id})">EDIT</button>
                        <button style="background:none; border:none; color:#F44336; font-size:11px;" onclick="deleteRoute(${r.id})">DEL</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function viewRoute(id) {
            const r = savedRoutes.find(x => x.id === id);
            currentMoves = r.moves; renderMarkers(); switchTab('create'); resetView();
        }

        function switchTab(t) {
            document.getElementById('create-view').style.display = t === 'create' ? 'block' : 'none';
            document.getElementById('list-view').style.display = t === 'list' ? 'block' : 'none';
            document.getElementById('nav-create').classList.toggle('active', t === 'create');
            document.getElementById('nav-list').classList.toggle('active', t === 'list');
            if (t === 'list') renderLogbook();
        }

        function undoLastMove() { currentMoves.pop(); renderMarkers(); }
        function clearMoves() { currentMoves = []; renderMarkers(); }
        function clearData() { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>