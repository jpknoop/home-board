<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Home Board Log Pro</title>
    <style>
        :root {
            --start-color: #4CAF50; --hand-color: #FF9800; --foot-color: #2196F3;
            --finish-color: #F44336; --dark: #1a1a1a; --card-bg: #2a2a2a;
            --light: #f4f4f4; --accent: #00BCD4; --benchmark-gold: #FFD700;
        }

        /* PHONE & IPAD SMOOTHNESS FIXES */
        html, body {
            overscroll-behavior-y: none;
            position: fixed;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark); color: var(--light); margin: 0; padding: 0;
            display: flex; flex-direction: column;
        }

        header {
            padding: 10px 20px; background: #111; display: flex;
            justify-content: space-between; align-items: center; border-bottom: 1px solid #333; z-index: 10;
        }

        #app-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* TABLET & DESKTOP LOGIC (Breakpoint adjusted to 768px to catch iPad Landscape) */
        @media (min-width: 768px) {
            #app-container { flex-direction: row; }
            #viewport-section { flex: 3; border-right: 1px solid #333; display: flex; flex-direction: column; position: relative; }
            .side-panel { width: 400px; overflow-y: auto; background: #1a1a1a; display: none; flex-direction: column; }
            .side-panel.active-panel { display: flex; }
            #desktop-nav { display: flex !important; gap: 8px; align-items: center; }
            nav#mobile-nav { display: none !important; }
        }

        #desktop-nav { display: none; }

        #viewport {
            width: 100%; height: 100%; min-height: 40vh; overflow: hidden; background: #000;
            position: relative; touch-action: none; cursor: crosshair;
            -webkit-user-select: none;
        }

        #board-wrapper { position: absolute; width: 100%; transform-origin: 0 0; will-change: transform; pointer-events: all; }
        #board-image { width: 100%; display: block; pointer-events: none; -webkit-user-drag: none; }

        /* Markers */
        .hold-marker {
            position: absolute; width: 18px; height: 18px; border-radius: 50%;
            transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 10px; pointer-events: none; border: 1.5px solid rgba(255,255,255,0.7); 
            color: white; text-shadow: 0 0 3px rgba(0,0,0,0.8); box-shadow: 0 0 5px rgba(0,0,0,0.3);
            opacity: 0.7;
        }
        .hold-marker.type-start { background-color: var(--start-color); }
        .hold-marker.type-hand { background-color: var(--hand-color); }
        .hold-marker.type-foot { background-color: var(--foot-color); width: 12px; height: 12px; opacity: 0.5; }
        .hold-marker.type-finish { background-color: var(--finish-color); border: 2px dashed rgba(255,255,255,0.8); }

        /* UI Styling */
        .controls { padding: 20px; background: var(--dark); }
        .marker-toolbar { display: flex; gap: 5px; margin-bottom: 15px; background: #000; padding: 5px; border-radius: 8px; }
        .type-btn { flex: 1; padding: 12px 0; text-align: center; font-size: 0.8rem; color: #666; cursor: pointer; user-select: none; }
        .type-btn.active { color: white; background: #333; border-radius: 4px; font-weight: bold; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px; background: #2a2a2a; 
            border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }

        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: bold; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: #444; color: white; }
        .btn-toggle { background: #222; color: #777; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .route-card { background: var(--card-bg); margin: 10px; padding: 15px; border-radius: 10px; border-left: 5px solid var(--accent); cursor: pointer; position: relative; }
        .route-card.benchmark { border-left-color: var(--benchmark-gold); }
        
        .ascent-tag { background: #444; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 4px; display: inline-block; margin-top: 4px; }
        .log-ascent-btn { position: absolute; bottom: 15px; right: 15px; background: #333; color: var(--accent); border: 1px solid var(--accent); font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        nav#mobile-nav { display: flex; background: #111; border-top: 1px solid #333; height: 65px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 20px; color: #777; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--accent); border-top: 3px solid var(--accent); }

        #setup-screen { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>

    <div id="setup-screen" style="display:none;">
        <div style="text-align:center; background:var(--card-bg); padding:40px; border-radius:20px; border:1px solid #444;">
            <h2>Upload Board</h2>
            <input type="file" id="imgInput" accept="image/*">
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <h1 style="margin:0; font-size: 1rem;">ðŸ§— Board Log</h1>
            <div id="desktop-nav">
                <button id="toggle-create" class="btn-toggle active" onclick="switchTab('create')">SETTER</button>
                <button id="toggle-list" class="btn-toggle" onclick="switchTab('list')">LOGBOOK</button>
            </div>
        </div>
        <button onclick="clearData()" style="color:#555; background:none; border:1px solid #333; padding: 4px 10px; border-radius:4px; font-size:10px; cursor:pointer;">RESET</button>
    </header>

    <div id="app-container">
        <div id="viewport-section">
            <div id="viewport">
                <div id="board-wrapper">
                    <img id="board-image" src="" alt="Board">
                    <div id="markers-container"></div>
                </div>
            </div>
            <div style="background:#222; padding:10px 20px; font-size:0.7rem; color:var(--accent); display:flex; justify-content:space-between; align-items:center;">
                <span>Pinch to Zoom â€¢ Drag to Move</span>
                <button onclick="resetZoom(event)" style="background:none; border:1px solid #555; color:#aaa; font-size:10px; padding:4px 10px; border-radius:4px;">RESET VIEW</button>
            </div>
        </div>

        <div id="create-view" class="side-panel active-panel">
            <div class="controls">
                <h3 style="margin-top:0;">New Route</h3>
                <div class="marker-toolbar">
                    <div class="type-btn active" onclick="setHoldType('start', event)" data-type="start">Start</div>
                    <div class="type-btn" onclick="setHoldType('hand', event)" data-type="hand">Hand</div>
                    <div class="type-btn" onclick="setHoldType('foot', event)" data-type="foot">Foot</div>
                    <div class="type-btn" onclick="setHoldType('finish', event)" data-type="finish">Finish</div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="flex:1" onclick="undoLastMove()">Undo</button>
                    <button class="btn btn-secondary" style="flex:1" onclick="clearMoves()">Clear</button>
                </div>

                <input type="text" id="route-name" placeholder="Route Name">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="route-grade" placeholder="Grade" style="flex:1;">
                    <select id="route-rating" style="flex:1;">
                        <option value="0">Rating</option>
                        <option value="1">â˜…â˜†â˜†</option>
                        <option value="2">â˜…â˜…â˜†</option>
                        <option value="3">â˜…â˜…â˜…</option>
                    </select>
                </div>
                <input type="text" id="route-setter" placeholder="Setter Name">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                    <input type="checkbox" id="route-benchmark" style="width:auto; margin:0;">
                    <label>Benchmark</label>
                </div>
                <textarea id="route-notes" rows="2" placeholder="Notes..."></textarea>
                <button id="save-btn" class="btn btn-primary" onclick="saveRoute()">Save Route</button>
            </div>
        </div>

        <div id="list-view" class="side-panel">
            <div class="filter-bar" style="padding:15px; background:#111; border-bottom:1px solid #333; display: flex; flex-direction: column; gap: 8px;">
                <input type="text" id="filter-search" placeholder="Search..." oninput="renderLogbook()" style="margin:0;">
                <div style="display: flex; gap: 5px;">
                    <select id="filter-grade" onchange="renderLogbook()" style="margin:0; font-size: 12px; padding: 8px; flex: 1.5;">
                        <option value="">All Grades</option>
                    </select>
                    <button id="btn-filter-bm" onclick="toggleBMFilter()" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; font-size: 11px;">BM Only</button>
                </div>
            </div>
            <div id="routes-list" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <nav id="mobile-nav">
        <div class="nav-item active" id="nav-create" onclick="switchTab('create')">BOARD</div>
        <div class="nav-item" id="nav-list" onclick="switchTab('list')">LOGBOOK</div>
    </nav>

    <script>
        let currentMoves = [];
        let savedRoutes = JSON.parse(localStorage.getItem('myRoutes')) || [];
        let boardImgData = localStorage.getItem('boardImage');
        let currentHoldType = 'start';
        let scale = 1, pointX = 0, pointY = 0, start = { x: 0, y: 0 }, evCache = [], prevDiff = -1, isDragging = false;
        let bmFilterActive = false;

        const boardWrapper = document.getElementById('board-wrapper');
        const boardImage = document.getElementById('board-image');
        const viewport = document.getElementById('viewport');

        if (boardImgData) { boardImage.src = boardImgData; } 
        else { document.getElementById('setup-screen').style.display = 'flex'; }

        document.getElementById('imgInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => { localStorage.setItem('boardImage', reader.result); location.reload(); };
            reader.readAsDataURL(e.target.files[0]);
        };

        // ENHANCED MOBILE TOUCH HANDLING
        viewport.addEventListener('pointerdown', (e) => {
            evCache.push(e);
            start = { x: e.clientX - pointX, y: e.clientY - pointY };
            isDragging = false;
        });

        viewport.addEventListener('pointermove', (e) => {
            const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
            if (index > -1) evCache[index] = e;

            if (evCache.length === 2) {
                isDragging = true;
                const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
                if (prevDiff > 0) scale = Math.min(Math.max(1, scale + (curDiff - prevDiff) * 0.01), 5);
                prevDiff = curDiff;
            } else if (evCache.length === 1) {
                if (Math.abs(e.clientX - (start.x + pointX)) > 5 || Math.abs(e.clientY - (start.y + pointY)) > 5) {
                    isDragging = true;
                    pointX = e.clientX - start.x;
                    pointY = e.clientY - start.y;
                }
            }
            updateTransform();
        });

        viewport.addEventListener('pointerup', (e) => {
            if (!isDragging && evCache.length === 1) {
                const rect = boardWrapper.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                let order = currentHoldType === 'foot' ? 0 : currentMoves.filter(m => m.type !== 'foot').length + 1;
                currentMoves.push({ x, y, type: currentHoldType, order });
                if (currentHoldType === 'start') setHoldType('hand');
                renderMarkers();
            }
            evCache = evCache.filter(ev => ev.pointerId !== e.pointerId);
            if (evCache.length < 2) prevDiff = -1;
        });

        function updateTransform() {
            boardWrapper.style.transform = `translate3d(${pointX}px, ${pointY}px, 0) scale(${scale})`;
        }

        function resetZoom() { scale = 1; pointX = 0; pointY = 0; updateTransform(); }

        function renderMarkers() {
            document.getElementById('markers-container').innerHTML = currentMoves.map(m => `
                <div class="hold-marker type-${m.type}" style="left:${m.x}%; top:${m.y}%">${m.type !== 'foot' ? m.order : ''}</div>
            `).join('');
        }

        function setHoldType(t, e) {
            if(e) e.stopPropagation();
            currentHoldType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t));
        }

        function saveRoute() {
            const name = document.getElementById('route-name').value;
            if (!name) return alert("Name required");
            savedRoutes.unshift({ 
                id: Date.now(), name, grade: document.getElementById('route-grade').value || "?", 
                setter: document.getElementById('route-setter').value || "Unknown",
                ascents: [], moves: [...currentMoves], 
                rating: parseInt(document.getElementById('route-rating').value), 
                isBenchmark: document.getElementById('route-benchmark').checked 
            });
            localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
            location.reload();
        }

        function logAscent(id, event) {
            event.stopPropagation();
            const name = prompt("Enter climber's name:");
            if (name) {
                const rIdx = savedRoutes.findIndex(r => r.id === id);
                if (rIdx > -1) {
                    if(!savedRoutes[rIdx].ascents) savedRoutes[rIdx].ascents = [];
                    savedRoutes[rIdx].ascents.push(name);
                    localStorage.setItem('myRoutes', JSON.stringify(savedRoutes));
                    renderLogbook();
                }
            }
        }

        function toggleBMFilter() {
            bmFilterActive = !bmFilterActive;
            document.getElementById('btn-filter-bm').style.borderColor = bmFilterActive ? 'var(--benchmark-gold)' : '#444';
            renderLogbook();
        }

        function renderLogbook() {
            const container = document.getElementById('routes-list');
            const search = document.getElementById('filter-search').value.toLowerCase();
            const grade = document.getElementById('filter-grade').value;

            const filtered = savedRoutes.filter(r => {
                const matchSearch = r.name.toLowerCase().includes(search);
                const matchGrade = !grade || r.grade === grade;
                const matchBM = !bmFilterActive || r.isBenchmark;
                return matchSearch && matchGrade && matchBM;
            });

            container.innerHTML = '';
            filtered.forEach(r => {
                const card = document.createElement('div');
                card.className = `route-card ${r.isBenchmark ? 'benchmark' : ''}`;
                card.onclick = () => { currentMoves = r.moves; renderMarkers(); if(window.innerWidth < 768) switchTab('create'); resetZoom(); };
                const stars = "â˜…".repeat(r.rating) + "â˜†".repeat(3 - r.rating);
                const ascTags = (r.ascents || []).map(n => `<span class="ascent-tag">${n}</span>`).join('');
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>${r.name}</strong><div style="font-size:9px; color:#777;">by ${r.setter}</div></div>
                        <span style="color:var(--accent); font-weight:bold;">${r.grade}</span>
                    </div>
                    <div style="font-size:10px; color:#555; margin-top:4px;">${stars}</div>
                    <div>${ascTags}</div>
                    <button class="log-ascent-btn" onclick="logAscent(${r.id}, event)">+ LOG</button>
                `;
                container.appendChild(card);
            });
        }

        function populateGrades() {
            const select = document.getElementById('filter-grade');
            [...new Set(savedRoutes.map(r => r.grade))].sort().forEach(g => {
                const opt = document.createElement('option'); opt.value = g; opt.textContent = g; select.appendChild(opt);
            });
        }

        function switchTab(t) {
            document.getElementById('create-view').classList.toggle('active-panel', t === 'create');
            document.getElementById('list-view').classList.toggle('active-panel', t === 'list');
            document.getElementById('nav-create').classList.toggle('active', t === 'create');
            document.getElementById('nav-list').classList.toggle('active', t === 'list');
            document.getElementById('toggle-create').classList.toggle('active', t === 'create');
            document.getElementById('toggle-list').classList.toggle('active', t === 'list');

            if (window.innerWidth < 768) {
                document.getElementById('create-view').style.display = t === 'create' ? 'flex' : 'none';
                document.getElementById('list-view').style.display = t === 'list' ? 'flex' : 'none';
            }
        }

        function undoLastMove() { currentMoves.pop(); renderMarkers(); }
        function clearMoves() { currentMoves = []; renderMarkers(); }
        function clearData() { if(confirm("Reset all?")) { localStorage.clear(); location.reload(); } }

        renderLogbook(); populateGrades();
    </script>
</body>
</html>